<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Python Editor</title>
        <link rel="stylesheet" href="styles.css" />
    </head>
    <body>
        <div class="container">
            <div class="header">
                <img
                    src="python-logo.svg"
                    alt="Python logo of two snakes"
                    height="29px"
                />
                <button id="run-button" class="button button-disabled" disabled>
                    Loading...
                </button>
            </div>

            <div class="content">
                <div class="editor-panel">
                    <div id="editor" style="height: 100%"></div>
                </div>

                <div class="output-panel">
                    <div class="output-header">
                        <h2 class="output-title">Output</h2>
                    </div>
                    <div class="output-content">
                        <pre class="output-text" id="output">Loading...</pre>
                    </div>
                </div>
            </div>
        </div>

        <script type="module">
            import {
                EditorView,
                minimalSetup,
            } from "https://esm.sh/codemirror@6.0.2";
            import { highlightActiveLine } from "https://esm.sh/@codemirror/view@6.38.6";
            import {
                indentOnInput,
                indentUnit,
                bracketMatching,
            } from "https://esm.sh/@codemirror/language@6.11.3";
            import { python } from "https://esm.sh/@codemirror/lang-python@6.2.1";
            //import { oneDark } from "https://esm.sh/@codemirror/theme-one-dark@6.1.3";
            import { githubLight } from "https://esm.sh/@uiw/codemirror-theme-github@4.25.2";

            const runButton = document.getElementById("run-button");
            const outputElement = document.getElementById("output");

            function getDecodedIdFromHash() {
                const hash = window.location.hash.substring(1);

                if (!hash) return "# Write code here";

                const encodedId = hash.split("=")[1];

                if (!encodedId) return "# Write code here";

                try {
                    return decodeUrlSafeBase64(encodedId);
                } catch (e) {
                    console.error("Failed to decode:", e);
                    return "# Failed to decode";
                }
            }

            function decodeUrlSafeBase64(str) {
                // Convert URL-safe to standard base64
                str = str.replace(/-/g, "+").replace(/_/g, "/");

                // Add padding
                while (str.length % 4) str += "=";

                // Decode to bytes and convert to UTF-8
                const bytes = Uint8Array.from(atob(str), (c) =>
                    c.charCodeAt(0),
                );
                return new TextDecoder().decode(bytes);
            }

            const initial_code = getDecodedIdFromHash();

            // Initialise Codemirror
            const editor = new EditorView({
                doc: initial_code,
                extensions: [
                    minimalSetup,
                    python(),
                    githubLight,
                    indentOnInput(),
                    indentUnit.of("    "),
                    bracketMatching(),
                    highlightActiveLine(),
                ],
                parent: document.getElementById("editor"),
            });

            // Get URL Parameter to check for micropip
            const params = new URLSearchParams(document.location.search);
            const loadMicropip = params.get("micropip") == "1" ? true : false;
            const libs = params.getAll("lib");

            // Configure worker settings
            const workerSettings = {
                loadMicropip,
                libs,
            };

            // Initialize Web Worker
            const worker = new Worker("./pyodide-worker.js", {
                type: "module",
            });
            let pyodideReady = false;
            let isRunning = false;

            // Send init message with settings
            worker.postMessage({
                type: "init",
                settings: workerSettings,
            });

            worker.onmessage = (event) => {
                const { type, output, error } = event.data;

                switch (type) {
                    case "ready":
                        pyodideReady = true;
                        updateButton();
                        outputElement.textContent = `Ready to run Python`;
                        break;

                    case "success":
                        outputElement.textContent = output;
                        isRunning = false;
                        updateButton();
                        break;

                    case "error":
                        outputElement.textContent = `Error: ${error}`;
                        isRunning = false;
                        updateButton();
                        break;
                }
            };

            worker.onerror = (error) => {
                outputElement.textContent = `Worker error: ${error.message || "Unknown error"}`;
                pyodideReady = false;
                isRunning = false;
                updateButton();
            };

            // Update button state
            function updateButton() {
                if (isRunning) {
                    runButton.textContent = "Running...";
                    runButton.disabled = true;
                    runButton.className = "button button-disabled";
                } else if (pyodideReady) {
                    runButton.textContent = "â–¶ Run Code";
                    runButton.disabled = false;
                    runButton.className = "button button-enabled";
                } else {
                    runButton.textContent = "Loading...";
                    runButton.disabled = true;
                    runButton.className = "button button-disabled";
                }
            }

            // Run code
            function runCode() {
                if (!worker || !pyodideReady || isRunning) {
                    return;
                }

                isRunning = true;
                updateButton();
                outputElement.textContent = "Running...";

                const code = editor.state.doc.toString();
                worker.postMessage({
                    type: "run",
                    code: code,
                });
            }

            // Button click handler
            runButton.addEventListener("click", runCode);
        </script>
    </body>
</html>
