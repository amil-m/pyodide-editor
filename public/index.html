<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Python Editor</title>
        <link rel="stylesheet" href="styles.css" />
    </head>
    <body>
        <div class="container">
            <div class="header">
                <img
                    src="python-logo.svg"
                    alt="Python logo of two snakes"
                    height="29px"
                />
                <button id="run-button" class="button button-disabled" disabled>
                    Loading...
                </button>
            </div>

            <div class="content" id="grid-container">
                <div class="editor-panel">
                    <div id="editor" style="height: 100%"></div>
                </div>

                <div class="output-panel">
                    <div class="resize-handle" id="resize-handle"></div>
                    <div
                        class="resize-handle-vertical"
                        id="resize-handle-vertical"
                        style="display: none"
                    ></div>
                    <div class="output-header">
                        <h2 class="output-title">Output</h2>
                    </div>
                    <div class="output-content">
                        <pre class="output-text" id="output">Loading...</pre>
                    </div>
                </div>
            </div>
        </div>

        <script type="module">
            import {
                EditorView,
                minimalSetup,
            } from "https://esm.sh/codemirror@6.0.2";
            import {
                highlightActiveLine,
                lineNumbers,
            } from "https://esm.sh/@codemirror/view@6.38.6";
            import {
                indentOnInput,
                indentUnit,
                bracketMatching,
            } from "https://esm.sh/@codemirror/language@6.11.3";
            import { python } from "https://esm.sh/@codemirror/lang-python@6.2.1";
            //import { oneDark } from "https://esm.sh/@codemirror/theme-one-dark@6.1.3";
            import { githubLight } from "https://esm.sh/@uiw/codemirror-theme-github@4.25.2";

            const runButton = document.getElementById("run-button");
            const outputElement = document.getElementById("output");

            function getDecodedIdFromHash() {
                const hash = window.location.hash.substring(1);

                if (!hash) return "# Write code here";

                const encodedId = hash.split("=")[1];

                if (!encodedId) return "# Write code here";

                try {
                    return decodeUrlSafeBase64(encodedId);
                } catch (e) {
                    console.error("Failed to decode:", e);
                    return "# Failed to decode";
                }
            }

            function decodeUrlSafeBase64(str) {
                // Convert URL-safe to standard base64
                str = str.replace(/-/g, "+").replace(/_/g, "/");

                // Add padding
                while (str.length % 4) str += "=";

                // Decode to bytes and convert to UTF-8
                const bytes = Uint8Array.from(atob(str), (c) =>
                    c.charCodeAt(0),
                );
                return new TextDecoder().decode(bytes);
            }

            const initial_code = getDecodedIdFromHash();

            // Initialise Codemirror
            const editor = new EditorView({
                doc: initial_code,
                extensions: [
                    minimalSetup,
                    python(),
                    githubLight,
                    indentOnInput(),
                    indentUnit.of("    "),
                    bracketMatching(),
                    highlightActiveLine(),
                    lineNumbers({
                        formatNumber: (lineNo) =>
                            String(lineNo).padStart(1, " "),
                    }),
                ],
                parent: document.getElementById("editor"),
            });

            // Get URL Parameter to check for micropip
            const params = new URLSearchParams(document.location.search);
            const loadMicropip = params.get("micropip") == "1" ? true : false;
            const libs = params.getAll("lib");

            // Configure worker settings
            const workerSettings = {
                loadMicropip,
                libs,
            };

            // Initialize Web Worker
            const worker = new Worker("./pyodide-worker.js", {
                type: "module",
            });
            let pyodideReady = false;
            let isRunning = false;

            // Send init message with settings
            worker.postMessage({
                type: "init",
                settings: workerSettings,
            });

            worker.onmessage = (event) => {
                const { type, output, error } = event.data;

                switch (type) {
                    case "ready":
                        pyodideReady = true;
                        updateButton();
                        outputElement.textContent = `Ready to run Python`;
                        break;

                    case "success":
                        outputElement.textContent = output;
                        isRunning = false;
                        updateButton();
                        break;

                    case "error":
                        outputElement.textContent = `Error: ${error}`;
                        isRunning = false;
                        updateButton();
                        break;
                }
            };

            worker.onerror = (error) => {
                outputElement.textContent = `Worker error: ${error.message || "Unknown error"}`;
                pyodideReady = false;
                isRunning = false;
                updateButton();
            };

            // Update button state
            function updateButton() {
                if (isRunning) {
                    runButton.textContent = "Running...";
                    runButton.disabled = true;
                    runButton.className = "button button-disabled";
                } else if (pyodideReady) {
                    runButton.textContent = "â–¶ Run Code";
                    runButton.disabled = false;
                    runButton.className = "button button-enabled";
                } else {
                    runButton.textContent = "Loading...";
                    runButton.disabled = true;
                    runButton.className = "button button-disabled";
                }
            }

            // Run code
            function runCode() {
                if (!worker || !pyodideReady || isRunning) {
                    return;
                }

                isRunning = true;
                updateButton();
                outputElement.textContent = "Running...";

                const code = editor.state.doc.toString();
                worker.postMessage({
                    type: "run",
                    code: code,
                });
            }

            // Button click handler
            runButton.addEventListener("click", runCode);
        </script>

        <script>
            const container = document.getElementById("grid-container");
            const handle = document.getElementById("resize-handle");
            const handleVertical = document.getElementById(
                "resize-handle-vertical",
            );

            // Calculate 50% of container width/height on load
            let col1Width = container.offsetWidth / 2;
            let row1Height = container.offsetHeight / 2;
            let isResizing = false;
            let isMobile = window.innerWidth < 768;
            const vertical_row_height = 0.6;

            // Set initial grid layout
            function updateGrid() {
                isMobile = window.innerWidth < 768;
                if (isMobile) {
                    // Ensure we have the correct container height
                    if (row1Height === 300) {
                        row1Height =
                            container.offsetHeight * vertical_row_height;
                    }
                    container.style.gridTemplateColumns = "1fr";
                    container.style.gridTemplateRows = `${row1Height}px 1fr`;
                    handleVertical.style.display = "block";
                } else {
                    container.style.gridTemplateColumns = `${col1Width}px 1fr`;
                    container.style.gridTemplateRows = "minmax(300px, 1fr)";
                    handleVertical.style.display = "none";
                }
            }

            // Update grid after DOM finishes loading
            setTimeout(() => {
                if (isMobile) {
                    row1Height = container.offsetHeight * vertical_row_height;
                }
                updateGrid();
            }, 0);

            // Handle horizontal resize (desktop)
            handle.addEventListener("mousedown", (e) => {
                if (isMobile) return;
                isResizing = true;
                e.preventDefault();
            });

            // Handle vertical resize (mobile)
            handleVertical.addEventListener("mousedown", (e) => {
                if (!isMobile) return;
                isResizing = true;
                e.preventDefault();
            });

            document.addEventListener("mousemove", (e) => {
                if (!isResizing) return;

                const containerRect = container.getBoundingClientRect();

                if (isMobile) {
                    // Vertical resize
                    const newHeight = e.clientY - containerRect.top;
                    if (
                        newHeight >= 200 &&
                        newHeight <= containerRect.height - 200
                    ) {
                        row1Height = newHeight;
                        updateGrid();
                    }
                } else {
                    // Horizontal resize
                    const newWidth = e.clientX - containerRect.left;
                    if (
                        newWidth >= 200 &&
                        newWidth <= containerRect.width - 200
                    ) {
                        col1Width = newWidth;
                        updateGrid();
                    }
                }
            });

            document.addEventListener("mouseup", () => {
                isResizing = false;
            });

            // Handle window resize
            window.addEventListener("resize", () => {
                const wasMobile = isMobile;
                isMobile = window.innerWidth < 768;

                // Recalculate when switching modes
                if (wasMobile !== isMobile) {
                    if (isMobile) {
                        row1Height =
                            container.offsetHeight * vertical_row_height;
                    } else {
                        col1Width = container.offsetWidth / 2;
                    }
                } else if (isMobile) {
                    // If staying in mobile mode but height changed, ensure row1Height is valid
                    const maxHeight = container.offsetHeight - 200; // Leave at least 200px for second item
                    if (row1Height > maxHeight) {
                        row1Height = maxHeight;
                    }
                }
                updateGrid();
            });
        </script>
    </body>
</html>
